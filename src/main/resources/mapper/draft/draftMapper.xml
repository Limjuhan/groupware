<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ldb.groupware.mapper.mybatis.draft.DraftMapper">

    <!-- 내전자결재 목록 조회   -->
    <select id="getMyDraftList" resultType="DraftListDto">
        SELECT
        d.doc_id AS docId,
        d.form_code as formCode,
        d.doc_title AS docTitle,
        DATE_FORMAT(d.doc_endDate, '%Y-%m-%d') AS docEndDate,
        d.mem_id AS writer,
        (SELECT mem_id FROM approval_line WHERE doc_id = d.doc_id AND step_order = 1) AS approver1,
        (SELECT mem_id FROM approval_line WHERE doc_id = d.doc_id AND step_order = 2) AS approver2,
        d.status AS status
        FROM approval_document d
        WHERE d.mem_id = #{memId}
        AND d.del_yn = 'N'

        <if test="dto.searchType != null and dto.keyword != null and dto.keyword != ''">
            <choose>
                <when test="dto.searchType == 'title'">
                    AND d.doc_title LIKE CONCAT('%', #{dto.keyword}, '%')
                </when>
                <when test="dto.searchType == 'writer'">
                    AND d.mem_id LIKE CONCAT('%', #{dto.keyword}, '%')
                </when>
            </choose>
        </if>

        ORDER BY d.doc_id DESC
        LIMIT #{dto.startNum}, #{dto.itemsPerPage}
    </select>


    <select id="getMyDraftCount" resultType="int" parameterType="map">
        SELECT COUNT(*)
        FROM approval_document d
        WHERE d.mem_id = #{memId}
        AND d.del_yn = 'N'
        <if test="type != null and keyword != null and keyword != ''">
            <choose>
                <when test="type == 'title'">
                    AND d.doc_title LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="type == 'writer'">
                    AND d.mem_id LIKE CONCAT('%', #{keyword}, '%')
                </when>
            </choose>
        </if>
    </select>


    <select id="getMemberList" resultType="DraftForMemberDto">
        SELECT m.mem_id as mem_id,
               m.mem_name as mem_name,
               d.dept_name as dept_name,
               r.rank_name as rank_name,
               m.mem_email as mem_email
        FROM member m
        LEFT JOIN dept d ON m.dept_id = d.dept_id
        LEFT JOIN rank r ON m.rank_id = r.rank_id
    </select>

    <!-- 잔여연차 조회 -->
    <select id="getRemainAnnual">
        SELECT remain_days
        FROM annual_leave
        WHERE mem_id = #{memId}
        and year = year(CURDATE())
    </select>

    <insert id="insertApprovalDocument" useGeneratedKeys="true" keyProperty="dto.docId">
        INSERT INTO approval_document
        (form_code, doc_title, doc_content, mem_id, created_at, status, updated_at, del_yn, doc_endDate)
        VALUES
            (#{dto.formCode}, #{dto.title},#{dto.content}, #{memId}, NOW(), #{status}, NOW(), 'N', #{dto.docEndDate})
    </insert>

    <insert id="insertFormAnnualLeave" parameterType="FormAnnualLeave">
        INSERT INTO `form_annual_leave` (
            `doc_id`,
            `form_code`,
            `leave_code`,
            `start_date`,
            `end_date`,
            `total_days`,
            `annual_content`
        ) VALUES (
                     #{docId},
                     #{formCode},
                     #{leaveCode},
                     #{startDate},
                     #{endDate},
                     #{totalDays},
                     #{annualContent}
                 )
    </insert>

    <insert id="insertApprovalLine">
        INSERT INTO approval_line (doc_id, mem_id, step_order, status, approved_at, approved_comment, ref_yn)
        VALUES (#{docId}, #{memId}, #{stepOrder}, 1, NOW(), NULL, #{refYn})
    </insert>

    <select id="getApprovalDocumentByDocId" resultType="DraftFormDto">
        SELECT a.doc_id as docId,
               a.form_code as formCode,
               a.doc_title as title,
               a.doc_content as content,
               a.doc_endDate as docEndDate,
               a.status as status,
               (SELECT mem_id FROM approval_line WHERE doc_id = #{docId} AND step_order = 1) AS approver1,
               (SELECT mem_id FROM approval_line WHERE doc_id = #{docId} AND step_order = 2) AS approver2
        FROM approval_document a
        WHERE a.doc_id = #{docId}
        AND   a.del_yn = 'N'
    </select>

    <!-- 내 전자결재 상세보기  -->
    <select id="getMyDraftDetail" resultType="DraftFormDto">
        SELECT
            a.doc_id AS docId,
            m.mem_name AS mem_name,
            a.form_code AS formCode,
            a.doc_title AS title,
            a.doc_content AS content,
            a.doc_endDate AS docEndDate,
            a.status AS status,
            approver1.mem_name AS approver1Name,
            approver2.mem_name AS approver2Name
        FROM approval_document a
        LEFT JOIN member m ON a.mem_id = m.mem_id
        LEFT JOIN approval_line l1 ON l1.doc_id = a.doc_id AND l1.step_order = 1 AND l1.ref_yn = 'N'
        LEFT JOIN member approver1 ON l1.mem_id = approver1.mem_id
        LEFT JOIN approval_line l2 ON l2.doc_id = a.doc_id AND l2.step_order = 2 AND l2.ref_yn = 'N'
        LEFT JOIN member approver2 ON l2.mem_id = approver2.mem_id
        WHERE a.doc_id = #{docId}
          AND a.del_yn = 'N'
    </select>

    <select id="getFormAnnualLeave" resultType="FormAnnualLeave">
        SELECT * FROM form_annual_leave WHERE doc_id = #{docId}
    </select>

    <select id="getFormProject" resultType="FormProject">
        SELECT * FROM form_project WHERE doc_id = #{docId}
    </select>

    <select id="getFormExpense" resultType="FormExpense">
        SELECT * FROM form_expense WHERE doc_id = #{docId}
    </select>

    <select id="getFormResign" resultType="FormResign">
        SELECT * FROM form_resign WHERE doc_id = #{docId}
    </select>

    <update id="updateFormProject" parameterType="FormProject">
        UPDATE form_project
        SET project_name = #{projectName},
            pro_content = #{proContent},
            start_date = #{startDate},
            end_date = #{endDate}
        WHERE doc_id = #{docId}
    </update>

    <update id="updateFormExpense" parameterType="FormExpense">
        UPDATE form_expense
        SET use_date = #{useDate},
            ex_name = #{exName},
            ex_amount = #{exAmount},
            ex_content = #{exContent}
        WHERE doc_id = #{docId}
    </update>

    <update id="updateFormResign" parameterType="FormResign">
        UPDATE form_resign
        SET resign_date = #{resignDate}
        WHERE doc_id = #{docId}
    </update>

    <update id="updateApprovalDocument">
        UPDATE approval_document
        SET
            form_code = #{dto.formCode},
            doc_title = #{dto.title},
            doc_content = #{dto.content},
            mem_id = #{memId},
            status = #{status},
            updated_at = NOW(),
            doc_endDate = #{dto.docEndDate}
        WHERE
            doc_id = #{dto.docId}
    </update>

    <insert id="insertFormProject" parameterType="FormProject">
        INSERT INTO form_project
            (doc_id, form_code, project_name, pro_content, start_date, end_date)
        VALUES
            (#{docId}, #{formCode}, #{projectName}, #{proContent}, #{startDate}, #{endDate})
    </insert>

    <insert id="insertFormExpense" parameterType="FormExpense">
        INSERT INTO form_expense
            (doc_id, form_code, use_date, ex_name, ex_amount, ex_content)
        VALUES
            (#{docId}, #{formCode}, #{useDate}, #{exName}, #{exAmount}, #{exContent})
    </insert>

    <insert id="insertFormResign" parameterType="FormResign">
        INSERT INTO form_resign
            (doc_id, form_code, resign_date)
        VALUES
            (#{docId}, #{formCode}, #{resignDate})
    </insert>



</mapper>